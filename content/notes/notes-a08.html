---
title: "Tidy Data and Pivoting"
output: 
  html_document:
    fig_caption: false
---



<pre class="r"><code>library(tidyverse)</code></pre>
<div id="learning-objectives" class="section level2">
<h2>Learning Objectives</h2>
<p>From this topic, students are anticipated to be able to:</p>
<ul>
<li>recognize whether a given dataset is ‘tidy’ or ‘untidy’</li>
<li>understand why ‘tidy’ data is useful</li>
<li>reshape a dataset between a ‘long’ and ‘wide’ format, using <code>tidyr::pivot_longer()</code> and <code>tidyr::pivot_wider()</code></li>
<li>deal with missing data in a tibble</li>
</ul>
</div>
<div id="resources" class="section level2">
<h2>Resources</h2>
<p>Video lecture for this topic:</p>
<ul>
<li><a href="https://youtu.be/qivE6exNsZI">tidyr for Pivoting and Tidy Data</a></li>
</ul>
<p>Written resources on tidy data:</p>
<ul>
<li><p>To learn how to use the <code>pivot_*()</code> functions, consult tidyr’s <a href="https://tidyr.tidyverse.org/articles/pivot.html">pivot vignette</a>.</p></li>
<li><p>To get a better understanding of the concept of tidy data:</p>
<ul>
<li>Hadley Wickham’s <a href="https://vita.had.co.nz/papers/tidy-data.pdf">paper on Tidy Data</a> is the gold standard treatment of tidy data.</li>
<li>A “code heavy” version of the tidy data paper is tidyr’s <a href="https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html">“Tidy Data” vignette</a>.</li>
</ul></li>
</ul>
</div>
<div id="tidy-data-and-the-tidyverse" class="section level2">
<h2>Tidy Data and the Tidyverse</h2>
<p>In the last two weeks, we learned about the <code>dplyr</code> package for data manipulation and the <code>ggplot2</code> package for graphing. These two packages are part of the “tidyverse”: a collection of data science packages that are designed to have input data frames and output data frames that are <em>tidy</em>. In fact, we can load all packages in the tidyverse at once with the single command <code>library(tidyverse)</code>.</p>
<p>Here, we are using the word “tidy” in a technical sense - we’re not talking about how “neat” or “organized” your data is. Instead, “tidy” is a very specific set of rules for storing data.</p>
<p><img src="https://www.openscapes.org/img/blog/tidydata/tidydata_1.jpg" alt="Stylized text providing an overview of Tidy Data. The top reads &quot;Tidy data is a standard way of mapping the meaning of a dataset to its structure. - Hadley Wickham.&quot; On the left reads &quot;In tidy data: each variable forms a column; each observation forms a row; each cell is a single measurement.&quot; There is an example table on the lower right with columns 'id', 'name' and 'color' with observations for different cats, illustrating tidy data structure." width="90%" /></p>
<p>(Image attribution: “<a href="https://www.openscapes.org/blog/2020/10/12/tidy-data/">Tidy Data for reproducibility, efficiency, and collaboration</a>” by <a href="https://jules32.github.io/">Julia Lowndes</a> and <a href="https://www.allisonhorst.com/">Allison Horst</a>.)</p>
<hr />
</div>
<div id="your-turn-work-with-some-untidy-data" class="section level2">
<h2>Your turn: work with some untidy data</h2>
<p>All of the data we used before this week were already tidy. This made it easy to use the tidyverse packages <code>dplyr</code> and <code>ggplot2</code> to do what we needed to do. What happens when that’s not the case?</p>
<p>The <code>fivethirtyeight</code> R package contains a dataset called <code>drinks</code>. This dataset was compiled as part of a <a href="https://fivethirtyeight.com/features/dear-mona-followup-where-do-people-drink-the-most-beer-wine-and-spirits/">FiveThirtyEight article</a> that explored (among other things) which countries consumes the most alcohol.</p>
<pre class="r"><code>library(fivethirtyeight)

drinks_tbl1 &lt;- as_tibble(drinks)
head(drinks_tbl1)</code></pre>
<pre><code>## # A tibble: 6 × 5
##   country     beer_servings spirit_servings wine_servings total_litres_of_pure…¹
##   &lt;chr&gt;               &lt;int&gt;           &lt;int&gt;         &lt;int&gt;                  &lt;dbl&gt;
## 1 Afghanistan             0               0             0                    0  
## 2 Albania                89             132            54                    4.9
## 3 Algeria                25               0            14                    0.7
## 4 Andorra               245             138           312                   12.4
## 5 Angola                217              57            45                    5.9
## 6 Antigua &amp; …           102             128            45                    4.9
## # ℹ abbreviated name: ¹​total_litres_of_pure_alcohol</code></pre>
<p>The following graphic was made from the <code>drinks</code> dataset.</p>
<p><img src="/notes/notes-a08_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>With a partner or a small group:</p>
<ol style="list-style-type: decimal">
<li>Is it possible to reproduce the plots above using <code>drinks_tbl1</code> and <em>only</em> the <code>dplyr</code> and <code>ggplot2</code> packages?</li>
<li>What is tidy format here? Mentally (or with pen and paper, or even with a spreadsheet editor like Excel or Google Sheets) sketch out the format of the tidy tibble.</li>
<li>How would you reproduce the plots above using the <code>ggplot2</code> packages, given the data set in tidy format?</li>
<li>Does it take a lot of code and effort to carry out the reproduction?</li>
</ol>
<p>Too easy? Then discuss the steps for how you would transform the first few rows of <code>drinks_tbl1</code> from untidy to tidy “by hand”, i.e. not by using the tools from the <code>tidyr</code> package that we will learn about this week.</p>
<hr />
</div>
<div id="tidy-depends-on-the-data-analysis-plan" class="section level2">
<h2>Tidy depends on the data analysis plan</h2>
<blockquote>
<p>“You better think (think) about what you’re trying to do …” - Aretha Franklin, “Think”</p>
</blockquote>
<p>It’s clear from the definition that tidiness is an attribute of a dataset. But did you know that tidiness also depends on what you are planning to <em>do</em> with the data? That’s because what’s an observation and what’s a variable depends on the data analysis plan!</p>
<p>We will demonstrate using data from “The Great British Bake Off” compiled by <a href="https://www.apreshill.com/">Allison Hill</a> in the R package <code>bakeoff</code>. The graphics that follow (and the code to produce the graphics) were lightly adapted from Allison’s <a href="https://www.apreshill.com/talk/2019-rladies-sydney/">Plot Twist talk</a>.</p>
<p>Here is a bar plot of the number of viewers in millions within a 7-day window per episode, coloured by series.</p>
<pre class="r"><code>library(bakeoff)

ratings_tbl1 &lt;- ratings %&gt;% 
  mutate(ep_id = row_number()) %&gt;% 
  select(ep_id, viewers_7day, series, episode) 

# create coordinates for labels
series_labels &lt;- ratings_tbl1 %&gt;% 
  mutate(series=as.factor(series)) %&gt;% 
  group_by(series) %&gt;% 
  summarize(y_position = median(viewers_7day) + 1,
            x_position = mean(ep_id))

# make the plot
ratings_tbl1 %&gt;% mutate(series=as.factor(series)) %&gt;% 
ggplot(aes(x = ep_id, y = viewers_7day, fill = series)) +
  geom_col(alpha = .9) + 
  ggtitle(&quot;7-Day Viewership across Series 1-10&quot;) +
  geom_text(data = series_labels, aes(label = series,
                                      x = x_position, 
                                      y = y_position)) +
  theme_classic() +  
  scale_fill_manual(values = bakeoff_palette(), 
                    guide = &quot;none&quot;) +
  xlab(&quot;Episode Number&quot;) + 
  ylab(&quot;7-Day Viewership (millions)&quot;)</code></pre>
<p><img src="/notes/notes-a08_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>This bar plot was constructed with the following tidy data representation:</p>
<pre><code>## # A tibble: 6 × 4
##   ep_id viewers_7day series episode
##   &lt;int&gt;        &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1     1         2.24      1       1
## 2     2         3         1       2
## 3     3         3         1       3
## 4     4         2.6       1       4
## 5     5         3.03      1       5
## 6     6         2.75      1       6</code></pre>
<p>Every row is an observation (a unique episode), and the columns are variables (episode number across series, 7-day viewership, series, and episode number within series).</p>
<div id="your-turn-whats-tidy-for-a-different-plot" class="section level3">
<h3>Your turn: what’s tidy for a different plot?</h3>
<p>Here is another bar plot displaying percentage increase in the number of viewers in millions within a 7-day window from the premiere episode to finale episode for the first 10 series, based on the tidy tibble <code>ratings_tbl2</code>.</p>
<pre class="r"><code>ratings_tbl2 %&gt;% mutate(pct_change = (last - first)/first) %&gt;% 
  ggplot(aes(x = fct_rev(series), y=pct_change)) + 
  geom_col(fill = bakeoff::bakeoff_colors(&quot;baltic&quot;), alpha = .5) + 
  labs(x = &quot;Series&quot;, y = &quot;% Increase in Viewers, First to Last Episode&quot;) +
  ggtitle(&quot;% Increase in Viewers from Premiere to Finale&quot;) + 
  scale_y_continuous(labels = scales::percent) +
  theme_classic() + 
  coord_flip() </code></pre>
<p><img src="/notes/notes-a08_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>With a partner or a small group:</p>
<ol style="list-style-type: decimal">
<li>What do you think <code>ratings_tbl2</code> looks like?</li>
<li>Why is it tidy?</li>
<li>Could you have calculated the information in <code>ratings_tbl2</code> using <code>ratings_tbl1</code>? (No need to write code - just discuss whether it’s possible.)</li>
</ol>
</div>
</div>
<div id="pivoting-for-tidying" class="section level2">
<h2>Pivoting for Tidying</h2>
<p>The <code>tidyr</code> package is loaded with the <code>tidyverse</code> and provides functions for pivoting data. It has two main “pivoting” type functions:</p>
<ol style="list-style-type: decimal">
<li><code>pivot_longer()</code> makes datasets <em>longer</em> by increasing the number of rows and decreasing the number of columns.</li>
<li><code>pivot_wider()</code> makes datasets <em>wider</em> by decreasing the number of rows and increasing the number of columns.</li>
</ol>
<p>By now, you should have a sense for why this might be useful for tidying!</p>
<div id="pivoting-wider" class="section level3">
<h3>Pivoting Wider</h3>
<p>Here is some code to create a variable for whether an episode is the first or last episode of the season to <code>ratings_tbl1</code> and subset to only the data from the first and last episodes of each eason.</p>
<pre class="r"><code>ratings_tbl1 &lt;- ratings_tbl1 %&gt;% 
 group_by(series) %&gt;% 
  filter(episode == 1 | episode == max(episode)) %&gt;%
  ungroup() %&gt;% 
  mutate(episode_fl = recode(episode, `1` = &quot;first&quot;, .default = &quot;last&quot;))

head(ratings_tbl1)</code></pre>
<pre><code>## # A tibble: 6 × 5
##   ep_id viewers_7day series episode episode_fl
##   &lt;int&gt;        &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;     
## 1     1         2.24      1       1 first     
## 2     6         2.75      1       6 last      
## 3     7         3.1       2       1 first     
## 4    14         5.06      2       8 last      
## 5    15         3.85      3       1 first     
## 6    24         6.74      3      10 last</code></pre>
<p>This is not the same as <code>ratings_tbl2</code>. To get it there, we need to make it wider. This is because compared to <code>ratings_tbl1</code> has spread
a single observation (a series) across multiple rows.</p>
<p>We can solve this problem using <code>pivot_wider</code>, which needs three pieces of information.</p>
<ul>
<li><p>What is a set of columns that uniquely identifies each observations? Put their names in the <code>id_cols</code> argument.</p></li>
<li><p>What should the new columns be named? Put the name of the column you want to take the new variable names from in the <code>names_from</code> argument.</p></li>
<li><p>What values should the new columns contain? Put the name of the column you want to take the values from to <code>values_from</code> in the <code>values_from</code> argument.</p></li>
</ul>
<p>Note that if you don’t specify an <code>id_cols</code> argument, <code>pivot_wider</code> will assume that you want it to be every column except those in <code>names_from</code> and <code>values_from</code>.</p>
<pre class="r"><code>ratings_tbl2 &lt;- ratings_tbl1 %&gt;% 
  pivot_wider(id_cols = series, 
              names_from=episode_fl, values_from=viewers_7day)

head(ratings_tbl2)</code></pre>
<pre><code>## # A tibble: 6 × 3
##   series first  last
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1      1  2.24  2.75
## 2      2  3.1   5.06
## 3      3  3.85  6.74
## 4      4  6.6   9.45
## 5      5  8.51 13.5 
## 6      6 11.6  15.0</code></pre>
</div>
<div id="pivoting-longer" class="section level3">
<h3>Pivoting Longer</h3>
<p>Here is a snippet of WHO data on the number of tuberculosis cases in different years in different countries.</p>
<pre class="r"><code>table4a</code></pre>
<pre><code>## # A tibble: 3 × 3
##   country     `1999` `2000`
##   &lt;chr&gt;        &lt;dbl&gt;  &lt;dbl&gt;
## 1 Afghanistan    745   2666
## 2 Brazil       37737  80488
## 3 China       212258 213766</code></pre>
<p>If we wanted to visualize tuberculosis cases over time by country, then this format is not tidy. We want every row to be an observation (measurements within a country and a year), and we want each column to be a variable, like the year, the case count, and the country name. That is, <code>table4a</code> is too <em>short</em>: each row contains information about multiple observations.</p>
<p>We can solve this problem using <code>pivot_longer</code>, which needs three pieces of information. We are going to decrease the number of columns, so …</p>
<ul>
<li><p>Which are the offending columns that we want to combine? Put their names in the <code>cols</code> argument.</p></li>
<li><p>These column names are often important though - so we should save them as values in a column of our new data set. What should the name of that column be? Put it in the <code>names_to</code> argument.</p></li>
<li><p>What should we name the column in our new data set that contains the values in the offending columns of the old data set? Put it in the <code>values_to</code> argument.</p></li>
</ul>
<pre class="r"><code>table4a %&gt;% pivot_longer(c(`1999`, `2000`), 
                         names_to = &quot;year&quot;, 
                         values_to = &quot;cases&quot;)</code></pre>
<pre><code>## # A tibble: 6 × 3
##   country     year   cases
##   &lt;chr&gt;       &lt;chr&gt;  &lt;dbl&gt;
## 1 Afghanistan 1999     745
## 2 Afghanistan 2000    2666
## 3 Brazil      1999   37737
## 4 Brazil      2000   80488
## 5 China       1999  212258
## 6 China       2000  213766</code></pre>
</div>
</div>
<div id="separating-and-uniting-for-tidying" class="section level2">
<h2>Separating and Uniting for Tidying</h2>
<p>The <code>tidyr</code> package has a function for gluing columns together (<code>unite</code>) and for cutting columns apart (<code>separate</code>). Why might this help us tidy? Here is another snippet of WHO Tuberculosis data.</p>
<pre class="r"><code>table3</code></pre>
<pre><code>## # A tibble: 6 × 3
##   country      year rate             
##   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;            
## 1 Afghanistan  1999 745/19987071     
## 2 Afghanistan  2000 2666/20595360    
## 3 Brazil       1999 37737/172006362  
## 4 Brazil       2000 80488/174504898  
## 5 China        1999 212258/1272915272
## 6 China        2000 213766/1280428583</code></pre>
<p>The <code>rate</code> column contains the values of two variables: case counts and population counts. We would like to snip it apart at the “/” character to create two columns:</p>
<pre class="r"><code>(table5 &lt;- table3 %&gt;% separate(col = rate, 
                    into = c(&quot;cases&quot;, &quot;population&quot;)))</code></pre>
<pre><code>## # A tibble: 6 × 4
##   country      year cases  population
##   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;     
## 1 Afghanistan  1999 745    19987071  
## 2 Afghanistan  2000 2666   20595360  
## 3 Brazil       1999 37737  172006362 
## 4 Brazil       2000 80488  174504898 
## 5 China        1999 212258 1272915272
## 6 China        2000 213766 1280428583</code></pre>
<p>The <code>col</code> argument specifies the column we want to separate,
and the <code>into</code> argument specifies the names of the new columns. The <code>sep</code> argument (not specified here) specifies where we want to cut. The default is pretty clever - it separates at any non-alphanumeric value. (How this is accomplished involves <em>regular expressions</em>, which are very useful when working with character data. We will learn more about regular expressions in STAT 545B. )</p>
</div>
<div id="your-turn-learning-to-use-tidyr" class="section level2">
<h2>Your turn: learning to use tidyr</h2>
<p>We think the best way to learn the basics of tidyr is to work through the first two parts of Worksheet A4.</p>
<div id="first-30-minutes-of-class-2" class="section level3">
<h3>First 30 minutes of Class 2</h3>
<ul>
<li>Haven’t attempted all of the questions on the first two parts of Worksheet A4? Then spend this time attempting unattempted questions.</li>
<li>Finished attempting all of the questions? Then do the optional <a href="https://r4ds.hadley.nz/data-tidy">R4DS Tidying</a> reading, and maybe even do some of the exercises for extra practice.</li>
</ul>
<p>During this time, teaching team will also walk around and answer questions and chat about anything tidy related.</p>
</div>
<div id="next-50-min-in-class-2" class="section level3">
<h3>Next 50 min in Class 2</h3>
<p>Now’s your chance to ask about any questions you got stuck on and get them answered by the instructor!</p>
</div>
</div>
<div id="coda-tidy-and-data-ethics" class="section level2">
<h2>Coda: Tidy and Data Ethics</h2>
<blockquote>
<p>“Of course, it is very easy to disregard people you have never met, and who are certainly not your friends or family members. After all, in the eyes of an outsider, who is in no danger whatsoever, the people caught up in the situation are nothing more than simply statistics.” - Andrew James Pritchard, “Not Collateral Damage”</p>
</blockquote>
<p>The book <a href="https://data-feminism.mitpress.mit.edu/">“Data Feminism”</a> by Catherine D’Ignazio and Lauren F. Klein “presents a new way of thinking about data science and data ethics that is informed by the ideas of intersectional feminism”. Power is an important theme throughout the book: they point out that “data collection has long been employed as a technique of consolidating knowledge about the people whose data are collected, and therefore consolidating power over their lives.”</p>
<p>In Chapter 5, the authors make several points about cleaning and tidying data:</p>
<ul>
<li><p>“Data do not need cleaning until there are strangers in the dataset … Being a stranger in the dataset is not an inherently bad thing, but it carries significant risk of what renowned postcolonial scholar Gayatri Spivak calls <em>epistemic violence</em> - the harm that dominant groups like colonial powers wreak by privileging their ways of knowing over local and Indigenous ways.”</p></li>
<li><p>Tidying data is a “lossy” process: “But what might be lost in the process of dominating and disciplining data? Whose perspectives might be lost in that process? And, conversely, whose perspectives might be additionally imposed?”</p></li>
<li><p>Further riffing on that point: “the process of cleaning and tidying data … at times, can be a destructive rather than constructive act. One way to think of it is like chopping off the roots of a tree that connects it to the ground from which it grew. <strong>It’s an act that irreversibly separates the data from their context.</strong>”</p></li>
<li><p>Untidy data is not inherently “bad”, and tidy data is not inherently “good”: “The ideas expressed by Wickham, and by the press, carry the assumption that all data scientists, in all contexts, value cleanliness and control over messiness and complexity … these are not the requirements, nor the goals, of all data projects.”</p></li>
</ul>
<p>These are important points for us to reflect on as a data science community.</p>
</div>
<div id="attribution" class="section level2">
<h2>Attribution</h2>
<p>Most of these notes were compiled by Lucy Gao. The remainder was compiled by previous iterations of the instructional staff, including Vincenzo Coia.</p>
<p>Albert Y. Kim inspired the in-class exercises using the <code>drinks</code> data set from <code>fivethirtyeight</code>. Allison Horst and Julia Lowndes created the illustrated tidy data series. Alison Hill inspired the Great British Bakeoff example. We are immensely grateful to these people for creating amazing educational materials!</p>
<p>We would also like to thank Samantha Tyner for pointing us towards the Data Feminism book during her week as the curator of the <a href="https://twitter.com/WomenInStat">@WomenInStat</a> Twitter account.</p>
</div>
